{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Upload PDF</h2>
  <form class="grid" action="/upload_lc" method="post" enctype="multipart/form-data">
    <label class="file-input">
      <span>Select a PDF</span>
      <input type="file" name="file" accept="application/pdf" required />
    </label>
    <button type="submit">Build LC Index</button>
  </form>
  <p class="muted">Builds a unified FAISS index using CLIP embeddings for text and images.</p>
</section>

<section class="card">
  <h2>Document Library</h2>
  <div id="documentLibrary">
    <p class="muted">Loading documents...</p>
  </div>
  <button id="refreshLibrary" style="margin-top: 10px;">Refresh Library</button>
</section>

<section class="card">
  <h2>Search</h2>
  <form class="grid" action="/search_lc_page" method="get">
    <input type="text" name="query" placeholder="Search your PDFs..." required />
    <input type="number" name="k" min="1" max="10" value="5" />
    <button type="submit">Search & View</button>
  </form>
  <p class="muted">Renders text excerpts and images inline.</p>
</section>

<script>
// Document Library Management
document.addEventListener('DOMContentLoaded', function() {
  const libraryDiv = document.getElementById('documentLibrary');
  const refreshBtn = document.getElementById('refreshLibrary');
  
  function loadDocumentLibrary() {
    libraryDiv.innerHTML = '<p class="muted">Loading documents...</p>';
    
    fetch('/get_document_info')
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          libraryDiv.innerHTML = `<p class="error">Error: ${data.error}</p>`;
          return;
        }
        
        if (data.documents.length === 0) {
          libraryDiv.innerHTML = '<p class="muted">No documents indexed yet. Upload a PDF to get started.</p>';
          return;
        }
        
        let html = '<div class="document-grid">';
        data.documents.forEach(doc => {
          html += `
            <div class="document-card">
              <div class="document-preview">
                <img src="/static/images/page_${doc.page}_img_0.png" 
                     alt="Page ${doc.page}" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="no-preview" style="display: none;">
                  <div class="preview-placeholder">
                    <span>ðŸ“„</span>
                    <p>Page ${doc.page}</p>
                  </div>
                </div>
              </div>
              <div class="document-info">
                <h4>Page ${doc.page}</h4>
                <p>${doc.image_count} images</p>
                <button onclick="searchPage(${doc.page})" class="search-page-btn">Search This Page</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        libraryDiv.innerHTML = html;
      })
      .catch(error => {
        libraryDiv.innerHTML = `<p class="error">Error loading documents: ${error.message}</p>`;
      });
  }
  
  refreshBtn.addEventListener('click', loadDocumentLibrary);
  
  // Load library on page load
  loadDocumentLibrary();
});

function searchPage(pageNumber) {
  const query = prompt(`Enter search query for page ${pageNumber}:`);
  if (query) {
    window.location.href = `/search_lc_page?query=${encodeURIComponent(query)}&k=5&page=${pageNumber}`;
  }
}
</script>

<style>
.document-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.document-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
  background: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

.document-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.document-preview {
  height: 150px;
  overflow: hidden;
  position: relative;
  background: #f5f5f5;
}

.document-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.preview-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #666;
}

.preview-placeholder span {
  font-size: 2em;
  margin-bottom: 8px;
}

.document-info {
  padding: 12px;
}

.document-info h4 {
  margin: 0 0 8px 0;
  color: #333;
}

.document-info p {
  margin: 0 0 12px 0;
  color: #666;
  font-size: 0.9em;
}

.search-page-btn {
  background: #4f46e5;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background 0.2s;
}

.search-page-btn:hover {
  background: #4338ca;
}

.error {
  color: #ef4444;
  font-weight: 500;
}
</style>
{% endblock %}
