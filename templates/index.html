{% extends 'base.html' %}
{% block content %}
<div class="chat-container">
  <div class="chat-header">
    <h2>AI Agent</h2>
    <p class="muted">Ask me anything</p>
  </div>
  
  <div class="chat-messages" id="chatMessages">
    <div class="message assistant-message">
      <div class="message-content">
        <p>Hello! I'm your AI agent. I'm here to help you with any questions or tasks. What would you like to know?</p>
      </div>
    </div>
  </div>
  
  <div class="chat-input-container">
    <form id="chatForm" class="chat-form">
      <div class="input-group">
        <input type="text" id="chatInput" placeholder="Ask me anything about your documents..." required />
        <button type="submit" id="sendButton">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
          </svg>
        </button>
      </div>
  </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const chatMessages = document.getElementById('chatMessages');
  const sendButton = document.getElementById('sendButton');
  
  function addMessage(content, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (typeof content === 'string') {
      contentDiv.innerHTML = `<p>${content}</p>`;
    } else {
      contentDiv.appendChild(content);
    }
    
    messageDiv.appendChild(contentDiv);
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  function setLoading(loading) {
    sendButton.disabled = loading;
    if (loading) {
      sendButton.innerHTML = '<div class="spinner"></div>';
    } else {
      sendButton.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22,2 15,22 11,13 2,9 22,2"></polygon></svg>';
    }
  }
  
  chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const query = chatInput.value.trim();
    if (!query) return;
    
    // Add user message
    addMessage(query, true);
    chatInput.value = '';
    
    setLoading(true);
    
    try {
      const requestData = {
        message: query,
        timestamp: new Date().toISOString(),
        session_id: generateSessionId()
      };
      
      console.log('DEBUG: Sending request to /chat with data:', requestData);
      
      // Send message through Flask /chat endpoint
      const response = await fetch('/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
      });
      
      console.log('DEBUG: Response status:', response.status);
      console.log('DEBUG: Response headers:', response.headers);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('DEBUG: Response data:', data);
      
      // Check if the webhook call was successful
      if (data.status === 'success' && data.webhook_response) {
        const webhookResponse = data.webhook_response;
        
        // Display the AI agent's response from webhook
        if (webhookResponse.response) {
          const responseData = webhookResponse.response;
          if (responseData.message) {
            addMessage(responseData.message);
          } else if (responseData.content) {
            addMessage(responseData.content);
          } else if (responseData.response) {
            addMessage(responseData.response);
          } else if (responseData.text) {
            addMessage(responseData.text);
          } else if (responseData.output) {
            addMessage(responseData.output);
          } else if (typeof responseData === 'string') {
            addMessage(responseData);
          } else {
            // Try to extract meaningful content from the response
            const keys = Object.keys(responseData);
            if (keys.length > 0) {
              const firstKey = keys[0];
              if (typeof responseData[firstKey] === 'string') {
                addMessage(responseData[firstKey]);
              } else {
                addMessage("AI Agent: " + JSON.stringify(responseData, null, 2));
              }
            } else {
              addMessage("AI Agent responded but no readable content found.");
            }
          }
        } else {
          addMessage("Message sent to AI agent successfully, but no response received yet.");
        }
      } else if (data.status === 'timeout') {
        addMessage("‚è∞ AI agent is taking longer than expected to respond. Please try again or check if your n8n workflow is properly configured.");
      } else {
        addMessage("Failed to send message to AI agent: " + (data.error || "Unknown error"));
      }
      
    } catch (error) {
      console.error('Chat error:', error);
      addMessage("Sorry, I couldn't connect to the AI agent. Please try again later.");
    } finally {
      setLoading(false);
    }
  });
  
  // Generate a simple session ID
  function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }
  
  
});
</script>

<style>
.chat-container {
  max-width: 800px;
  margin: 0 auto;
  height: calc(100vh - 200px);
  display: flex;
  flex-direction: column;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  overflow: hidden;
}

.chat-header {
  padding: 20px;
  border-bottom: 1px solid var(--border);
  background: var(--card);
}

.chat-header h2 {
  margin: 0 0 8px 0;
  color: var(--text);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.message {
  display: flex;
  margin-bottom: 16px;
}

.user-message {
  justify-content: flex-end;
}

.assistant-message {
  justify-content: flex-start;
}

.message-content {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 18px;
  word-wrap: break-word;
}

.user-message .message-content {
  background: #4f46e5;
  color: white;
  border-bottom-right-radius: 4px;
}

.assistant-message .message-content {
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.chat-input-container {
  padding: 20px;
  border-top: 1px solid var(--border);
  background: var(--card);
}

.chat-form {
  width: 100%;
}

.input-group {
  display: flex;
  gap: 12px;
  align-items: center;
}

#chatInput {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: 24px;
  font-size: 16px;
  outline: none;
  transition: border-color 0.2s;
  background: var(--bg);
  color: var(--text);
}

#chatInput:focus {
  border-color: var(--accent);
}

#chatInput::placeholder {
  color: var(--muted);
}

#sendButton {
  width: 48px;
  height: 48px;
  border: none;
  border-radius: 50%;
  background: var(--accent);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.2s;
}

#sendButton:hover:not(:disabled) {
  background: #4338ca;
}

#sendButton:disabled {
  background: var(--muted);
  cursor: not-allowed;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid transparent;
  border-top: 2px solid currentColor;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


@media (max-width: 768px) {
  .chat-container {
    height: calc(100vh - 150px);
    margin: 0;
    border-radius: 0;
  }
  
  .message-content {
    max-width: 85%;
  }
  
  .chat-header,
  .chat-messages,
  .chat-input-container {
    padding: 16px;
  }
}
</style>
{% endblock %}


